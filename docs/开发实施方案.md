# 降雨时序预测开发实施方案

## 1. 目标
- 使用现有代码和数据在本地跑通降雨时序预测。
- 产出可复现的训练结果与可视化图，便于评估效果。
- 所有 Python 操作均在项目虚拟环境内执行。

## 2. 当前仓库事实
- 训练入口：`scripts/train.py`
- 默认配置：`configs/gz_rain.yaml`
- 本地数据：`20152024.xlsx`
- 模型输出：
  - `runs/<exp_name>/metrics_all.json`
  - `runs/<exp_name>/predictions_all.csv`
  - `runs/<exp_name>/<city>/metrics.json`

## 3. 已锁定技术决策
- Python 环境：3.12 + `venv`
- 目标范围：全城市（`target_city: "__all__"`）
- 训练策略：先快速验证（`epochs=8`）
- 模型后端：优先 GRU fallback（不强制安装 `mamba-ssm`）
- 可视化形式：时序折线图（真实值 vs 预测值，含预测区间）

## 4. 环境准备
在仓库根目录执行：

```powershell
.\venv\Scripts\Activate.ps1
python -V
python -m pip install --upgrade pip
python -m pip install -r requirements.txt
```

## 5. 配置方案
- 新增快速全城市配置：`configs/gz_rain_quick_all.yaml`
- 关键参数：
  - `data_path: 20152024.xlsx`
  - `target_city: "__all__"`
  - `train.epochs: 8`

## 6. 训练执行

```powershell
python scripts/train.py --config configs/gz_rain_quick_all.yaml --device cpu
```

## 7. 可视化执行
- 新增脚本：`scripts/plot_predictions.py`
- 功能：按城市绘制 `horizon=1` 的真实值和预测值折线图；若存在 `y_lo/y_hi` 同时绘制区间带。

```powershell
python scripts/plot_predictions.py ^
  --pred_csv runs/gz_rain_da_deformmamba/predictions_all.csv ^
  --out_dir runs/gz_rain_da_deformmamba/plots ^
  --horizon 1 ^
  --tail_points 300
```

## 8. 验收标准
- 训练成功结束，无运行时异常。
- `runs/gz_rain_da_deformmamba/metrics_all.json` 存在且非空。
- `runs/gz_rain_da_deformmamba/predictions_all.csv` 存在且非空。
- `runs/gz_rain_da_deformmamba/plots/` 下有各城市图像文件。

## 9. 常见问题与处理
- `ModuleNotFoundError`：确认已激活 `venv` 并安装依赖。
- 训练较慢：先保持快速配置（8 epochs）验证流程，再提升到 40 epochs。
- 中文文件名显示异常：不影响训练和指标，可在后处理阶段调整字体。

## 10. 后续扩展
- 将 `epochs` 恢复到 40 进行正式训练。
- 如需贴近论文，实现安装 `mamba-ssm` 后复跑并对比指标。
