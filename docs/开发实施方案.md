# 降雨时序预测开发实施方案（云GPU + 强制Mamba）

## 1. 目标
- 使用云端 GPU 服务器运行 DA-DeformMamba，并强制使用 `mamba-ssm`。
- 禁止 GRU fallback：若 `mamba-ssm` 不可用，训练直接失败。
- 输出并可视化：训练损失、预测曲线、MAE、RMSE。

## 2. 当前仓库关键入口
- 训练入口：`scripts/train.py`
- 两城市配置（普通）：`configs/gz_rain_quick_2cities.yaml`
- 两城市配置（强制Mamba）：`configs/gz_rain_quick_2cities_mamba.yaml`
- 可视化脚本：
  - `scripts/plot_predictions.py`（预测图）
  - `scripts/plot_results.py`（损失 + 预测 + MAE/RMSE）

## 3. 已实现的关键改造
- 强制 Mamba：
  - 新增配置项 `model.require_mamba`。
  - 当 `require_mamba: true` 且 `mamba_ssm` 不可导入时，立即抛出错误。
- 训练历史落盘：
  - 每城市保存 `runs/<exp>/<city>/history.csv`。
  - 汇总保存 `runs/<exp>/history_all.csv`。
- 训练脚本支持城市列表：
  - `target_city: ["贵阳市","遵义市"]`。

## 4. 云服务器规格建议
- OS：`Ubuntu 22.04 LTS`
- GPU：`NVIDIA T4 16GB` 或更高
- CPU：4 vCPU+
- RAM：16GB+
- Disk：80GB+

## 5. 云端部署与运行命令
以下命令在云服务器终端执行。

### 5.1 系统准备
```bash
sudo apt update
sudo apt install -y git wget curl build-essential python3.12 python3.12-venv python3-pip
```

### 5.2 GPU检查
```bash
nvidia-smi
```
若命令不可用，先按云平台文档安装或切换到预装驱动镜像。

### 5.3 拉取代码与虚拟环境
```bash
git clone <你的仓库地址> rainfall
cd rainfall
python3.12 -m venv venv
source venv/bin/activate
python -V
```

### 5.4 安装依赖（CUDA版PyTorch + mamba-ssm）
```bash
pip install --upgrade pip
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu124
pip install -r requirements.txt
pip install mamba-ssm
```

### 5.5 环境验收
```bash
python -c "import torch, importlib.util; print('cuda=', torch.cuda.is_available()); print('mamba=', importlib.util.find_spec('mamba_ssm') is not None)"
```
预期输出：
- `cuda= True`
- `mamba= True`

### 5.6 强制Mamba训练（两城市）
```bash
export PYTHONPATH=.
python -u -m scripts.train --config configs/gz_rain_quick_2cities_mamba.yaml --device cuda 2>&1 | tee runs/train_2cities_mamba.log
```

### 5.7 可视化输出
```bash
python scripts/plot_results.py --exp_dir runs/gz_rain_da_deformmamba_2cities_mamba --horizon 1 --tail_points 300
```

## 6. 输出文件说明
- 训练与预测：
  - `runs/<exp>/<city>/best.pt`
  - `runs/<exp>/<city>/metrics.json`
  - `runs/<exp>/<city>/predictions.csv`
  - `runs/<exp>/<city>/history.csv`
- 汇总：
  - `runs/<exp>/metrics_all.json`
  - `runs/<exp>/predictions_all.csv`
  - `runs/<exp>/history_all.csv`
- 可视化：
  - `runs/<exp>/plots/loss_curve_<city>.png`
  - `runs/<exp>/plots/prediction_<city>_h1.png`
  - `runs/<exp>/plots/metric_bar_rmse_mae.png`

## 7. 验收标准
- 日志中不出现 `Using GRU fallback`。
- 两城市训练完成，且上述文件齐全。
- `plot_results.py` 成功生成损失图、预测图、MAE/RMSE图。

## 8. 常见问题
- 报 `require_mamba=True but mamba_ssm is not available`：
  - 说明环境未正确安装 `mamba-ssm`，或当前不是兼容平台（需 Linux + CUDA）。
- 报 `ModuleNotFoundError: utils`：
  - 请使用模块方式运行：`python -m scripts.train` 并设置 `PYTHONPATH=.`。
- 显存不足：
  - 先降 `batch_size`（例如 64 -> 32），必要时再降低 `d_model`。
